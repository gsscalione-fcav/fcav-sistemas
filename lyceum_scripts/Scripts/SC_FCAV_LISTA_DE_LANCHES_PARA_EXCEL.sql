
 WITH MATRICULADOS_MANHA AS
 (
	SELECT 
		DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		ALUNO
	FROM 
		VW_FCAV_AGENDA_ALUNO_DISCIPLINA AG2 
	WHERE HORA_INICIO < '11:00:00'
	GROUP BY DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		ALUNO
 ),
 MATRICULADOS_TARDE AS 
 (
	SELECT 
		DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		ALUNO
	FROM 
	VW_FCAV_AGENDA_ALUNO_DISCIPLINA AG2 
	WHERE HORA_INICIO > '11:00:00'
	GROUP BY DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		ALUNO
 ),
--RETORNA OS ALUNOS QUE NÃO ESTÃO NOS DOIS HORARIOS DO DIA
MATRICULADOS_1_DISCIPLINA_DIA AS 
(
	
	SELECT DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		ALUNO
	from MATRICULADOS_MANHA as T1
	where ALUNO NOT IN (SELECT ALUNO from MATRICULADOS_TARDE)

	union all

	SELECT DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		ALUNO
	from MATRICULADOS_TARDE as T1
	where ALUNO NOT IN (SELECT ALUNO from MATRICULADOS_MANHA)

),
--RETORNA OS ALUNOS QUE ESTÃO NOS DOIS HORARIOS DO DIA
MATRICULADOS_2_DISCIPLINAS_DIA AS 
(
	SELECT DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		ALUNO AS ALUNO
	from MATRICULADOS_MANHA as T1
	where ALUNO IN (SELECT ALUNO from MATRICULADOS_TARDE)
),


--------------------------------
MATRICULADOS_DIA AS (
  SELECT  
		DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		COUNT(ALUNO) ALUNO_1_DISC,
		0 ALUNOS_2_DISC
	
	FROM 
		MATRICULADOS_1_DISCIPLINA_DIA
	GROUP BY
		TURMA,
		ANO,
		SEMESTRE,
		DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM
	
UNION ALL
	
  SELECT  
		DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM,
		TURMA,
		ANO,
		SEMESTRE,
		0 AS ALUNO_1_DISC,
		COUNT(ALUNO) ALUNOS_2_DISC
	FROM 
		MATRICULADOS_2_DISCIPLINAS_DIA

	GROUP BY
		TURMA,
		ANO,
		SEMESTRE,
		DATA,
		DIA,
		HORA_INICIO,
		HORA_FIM
)
-------------------------------

SELECT 
	AG.DATA,
	AG.DIA,
	AG.HORA_INICIO,
	AG.HORA_FIM,
	AG.DISCIPLINA,
	AG.DOCENTE,
	AG.UNIDADE,
	AG.SALA,
	AG.NOME_DISCIPLINA,
	AG.TURMA,
	AG.ANO,
	AG.SEMESTRE,
	AG.CATEGORIA,
	AG.CONCURSO,
	AG.CANCELADA,
	TP.ALUNO_1_DISC,
	TP.ALUNOS_2_DISC
FROM 
	VW_FCAV_AGENDA_ALUNO_DISCIPLINA AG
	LEFT JOIN MATRICULADOS_DIA TP
		ON TP.TURMA = AG.TURMA
		AND TP.DATA = AG.DATA
		AND TP.ANO = AG.SEMESTRE
	WHERE 
		AG.DATA = '2018-09-15'