/*
	Referente ao chamado do Rafael

	Pedidos 	Período	Reajuste
	De 	Até		De 			Até			Errado		Correto
189807	190006	01/11/2016	30/11/2016	19,6369%	10,8074%
193065	193373	01/11/2017	30/11/2017  19,6369%	10,8074%

190008	190178	01/12/2016	28/12/2016	18,4348%	9,6940%
193374	193620	01/01/2017	31/12/2017  18,4348%	9,6940%

191181	191262	01/01/2017	31/01/2017	16,1222%	7,5521%
193621	193628	01/01/2018	31/01/2018	16,1222%	7,5521%
924894	925015  01/01/2018	31/01/2018	16,1222%	7,5521%

191263	191406	01/02/2017	24/02/2017	15,2579%	6,7516%
925016	925179	01/02/2018	28/02/2018	15,2579%	6,7516%

*/
USE DADOSADVP12
go

if OBJECT_ID('TempDB.dbo.#TMP_CORRECAO_IGPM') IS NOT NULL
begin
	DROP TABLE #TMP_CORRECAO_IGPM
end



DECLARE @IGPM_ERRADO NUMERIC
DECLARE @IGPM_CORRETO NUMERIC
DECLARE @C6_NUM_INICIAL VARCHAR (6)
DECLARE @C6_NUM_FINAL VARCHAR (6)
DECLARE @C5_EMISSAO_INICIAL VARCHAR (8)
DECLARE @C5_EMISSAO_FINAL VARCHAR (8)
DECLARE @C5_CATIV VARCHAR (3)


-- 1 --  "seta" os parâmetros com os dados necessários

SET @C5_CATIV = '402'

SET @C6_NUM_INICIAL = '189807'
SET @C6_NUM_FINAL   = '190006'

SET @C5_EMISSAO_INICIAL = '20161101'
SET @C5_EMISSAO_FINAL   = '20161130'

SET @IGPM_ERRADO  = 19.6369
SET @IGPM_CORRETO = 10.8074

-- 2 --  Monta a tabela temporária fazendo o calculo de correção para encontrar o valor original e aplicando o igpm correto
SELECT 
	C5.C5_CATIV,
	C6_DESC,
	C5_EMISSAO,
	C6_DTULREA, 
	C6_DTANTRJ, 
	C5_CLIENTE, 
	C6_NUM, 
	C6_ITEM, 
	C6_PRCVEN,
	C6_VALOR,
	C6_ULTVAL, 
	CAST(C6_VALOR - ((C6_VALOR * @IGPM_ERRADO)/100) AS NUMERIC (10,2)) AS C6_VALORIG, 
	CAST((C6_VALOR - ((C6_VALOR * @IGPM_CORRETO)/100))*(1+10.8074/100) AS NUMERIC (10,2)) AS C6_VALREAJ,
	C6_ULTREAJ
	INTO #TMP_CORRECAO_IGPM
FROM 
	SC6010 C6
	INNER JOIN SC5010 C5
		ON C6.C6_NUM = C5.C5_NUM
WHERE 
	C6_NUM BETWEEN @C6_NUM_INICIAL AND @C6_NUM_FINAL
	AND C5_EMISSAO BETWEEN @C5_EMISSAO_INICIAL AND @C5_EMISSAO_FINAL
	AND C5.C5_CATIV = @C5_CATIV


-- 3 --  Atualiza os valores 
UPDATE SC6010
SET
	C6_PRCVEN = IGPM.C6_VALREAJ,
	C6_VALOR  = IGPM.C6_VALREAJ
FROM 
	SC6010 C6
	INNER JOIN #TMP_CORRECAO_IGPM IGPM
		ON	IGPM.C6_NUM = C6.C6_NUM
		AND IGPM.C6_ITEM = C6.C6_ITEM


-- 4 --  Consulta os valores após update
-------------------------------------------------------------------------------------------------
SELECT 
	C6.C6_DESC,
	C6.C6_DTULREA, 
	C6.C6_DTANTRJ, 
	C6.C6_NUM, 
	C6.C6_ITEM, 
	C6.C6_PRCVEN,
	C6.C6_VALOR,
	C6.C6_ULTVAL,
	IGPM.C6_VALORIG,
	IGPM.C6_VALREAJ
FROM 
	SC6010 C6
	INNER JOIN #TMP_CORRECAO_IGPM IGPM
		ON	IGPM.C6_NUM = C6.C6_NUM
		AND IGPM.C6_ITEM = C6.C6_ITEM
GROUP BY 
	C6.C6_DESC,
	C6.C6_DTULREA, 
	C6.C6_DTANTRJ, 
	C6.C6_NUM, 
	C6.C6_ITEM, 
	C6.C6_PRCVEN,
	C6.C6_VALOR,
	C6.C6_ULTVAL,
	IGPM.C6_VALORIG,
	IGPM.C6_VALREAJ

---------------------------------------
--Apaga a pasta temporária
	DROP TABLE #TMP_CORRECAO_IGPM